# 1.0-BE-Authentication-System

## Description
Implement the backend authentication system with role-based access control, JWT tokens, and user management.

## Dependencies
- None (first backend task)

## Files to Create/Modify
- `backend/src/auth/auth.controller.ts` - Authentication controller
- `backend/src/auth/auth.service.ts` - Authentication service
- `backend/src/auth/auth.module.ts` - Authentication module
- `backend/src/entities/User.ts` - User entity
- `backend/src/entities/Clinic.ts` - Clinic entity
- `backend/src/entities/Therapist.ts` - Therapist entity
- `backend/src/dto/auth.dto.ts` - Authentication DTOs
- `backend/src/guards/JwtAuthGuard.ts` - JWT authentication guard
- `backend/src/guards/RolesGuard.ts` - Role-based access guard
- `backend/src/decorators/roles.decorator.ts` - Role decorators
- `backend/src/config/jwt.config.ts` - JWT configuration

## Tasks

### 1.1-BE-User-Entities
- [ ] Create User, Clinic, and Therapist entities
- [ ] Implement role-based user model
- [ ] Add JWT token management
- [ ] Create authentication guards

**Implementation Steps:**
1. Create User entity with role-based fields
2. Implement Clinic entity with subscription information
3. Create Therapist entity with specialization and license
4. Set up entity relationships and constraints
5. Implement JWT token generation and validation
6. Create authentication guards for route protection
7. Add password hashing with bcrypt
8. Implement refresh token functionality

### 1.2-BE-Auth-Controllers
- [ ] Implement login endpoint
- [ ] Create clinic registration endpoint
- [ ] Add password hashing and validation
- [ ] Implement JWT token generation

**Implementation Steps:**
1. Create login endpoint with email/password validation
2. Implement clinic registration with approval workflow
3. Add password hashing and validation logic
4. Create JWT token generation and refresh endpoints
5. Implement logout and token invalidation
6. Add password reset functionality
7. Create email verification endpoints
8. Implement session management

### 1.3-BE-Role-Guards
- [ ] Create role-based access guards
- [ ] Implement permission decorators
- [ ] Add route protection middleware
- [ ] Create admin approval system

**Implementation Steps:**
1. Create role-based access guards for different user types
2. Implement permission decorators for route protection
3. Add middleware for route protection
4. Create admin approval system for clinic registrations
5. Implement role validation logic
6. Add audit logging for authentication events
7. Create role-based menu generation
8. Implement deep link protection

## Database Schema
```sql
-- Users table
CREATE TABLE users (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  email VARCHAR(255) UNIQUE NOT NULL,
  password_hash VARCHAR(255) NOT NULL,
  role VARCHAR(50) NOT NULL CHECK (role IN ('administrator', 'clinic_admin', 'therapist')),
  name VARCHAR(255) NOT NULL,
  is_active BOOLEAN DEFAULT true,
  email_verified BOOLEAN DEFAULT false,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Clinics table
CREATE TABLE clinics (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  name VARCHAR(255) NOT NULL,
  address TEXT,
  phone VARCHAR(50),
  email VARCHAR(255),
  website VARCHAR(255),
  logo_url VARCHAR(500),
  subscription_tier VARCHAR(50) DEFAULT 'alpha',
  verification_status VARCHAR(50) DEFAULT 'pending',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Therapists table
CREATE TABLE therapists (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES users(id),
  clinic_id UUID REFERENCES clinics(id),
  specialization VARCHAR(255),
  license_number VARCHAR(100),
  status VARCHAR(50) DEFAULT 'active',
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);
```

## Success Criteria
- [ ] User authentication works with JWT tokens
- [ ] Role-based access control is properly implemented
- [ ] Clinic registration requires admin approval
- [ ] Password hashing and validation work correctly
- [ ] JWT token refresh functionality works
- [ ] All endpoints are properly protected
- [ ] Audit logging captures authentication events
- [ ] Email verification system is functional

## Testing
- [ ] Unit tests for authentication service
- [ ] Unit tests for JWT guards
- [ ] Integration tests for authentication endpoints
- [ ] E2E tests for login and registration flow 