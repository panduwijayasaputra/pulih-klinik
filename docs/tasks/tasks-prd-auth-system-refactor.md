# Task List: Auth System Refactor

Based on PRD: `prd-auth-system-refactor.md`

## Relevant Files

- `frontend/src/types/auth.ts` - Contains current auth type definitions that need simplification
- `frontend/src/hooks/useAuth.ts` - Main auth hook that needs refactoring for simplified state management
- `frontend/src/lib/api/auth.ts` - Auth API client that needs streamlining
- `frontend/src/store/auth.ts` - Auth store that needs simplification (referenced but not found)
- `frontend/src/components/auth/RouteGuard.tsx` - Route protection component that needs updating
- `frontend/src/components/auth/LoginForm.tsx` - Login form component (needs to be created/updated)
- `frontend/src/components/auth/RegistrationForm.tsx` - Registration form component (needs to be created/updated)
- `frontend/src/components/auth/EmailVerificationForm.tsx` - Email verification component (needs to be created/updated)
- `frontend/src/components/onboarding/OnboardingFlow.tsx` - Onboarding flow component that needs refactoring
- `frontend/src/store/onboarding.ts` - Onboarding store that needs simplification
- `frontend/src/lib/api/registration.ts` - Registration API client (needs to be created)
- `frontend/src/schemas/authSchema.ts` - Auth validation schemas (needs to be created/updated)
- `backend/src/auth/auth.service.ts` - Backend auth service that needs simplification
- `backend/src/auth/auth.controller.ts` - Backend auth controller that needs streamlining
- `backend/src/registration/registration.service.ts` - Registration service that needs email verification
- `backend/src/registration/registration.controller.ts` - Registration controller that needs email verification endpoints
- `backend/src/database/entities/user.entity.ts` - User entity (already has email verification fields)

### Notes

- Unit tests should typically be placed alongside the code files they are testing (e.g., `MyComponent.tsx` and `MyComponent.test.tsx` in the same directory).
- Use `npx jest [optional/path/to/test/file]` to run tests. Running without a path executes all tests found by the Jest configuration.

## Tasks

- [x] 1.0 Refactor Authentication Data Structure and State Management
  - [x] 1.1 Simplify auth types and interfaces
    - Update `frontend/src/types/auth.ts` to include only essential fields: user info (id, email, name, isActive), clinic info (id, name, isActive, subscription), roles, access token, refresh token
    - Remove complex nested structures and unnecessary fields
    - Create simplified `AuthState` interface with clear, minimal properties
    - Update `User` interface to match backend response structure exactly
  - [x] 1.2 Refactor auth store for centralized state management
    - Create or update `frontend/src/store/auth.ts` with simplified Zustand store
    - Implement clear actions: login, logout, setUser, setClinic, setTokens, clearError
    - Add loading states for different auth operations
    - Implement token management with automatic refresh logic
    - Add data validation timestamps for cache management
  - [x] 1.3 Update auth hook for simplified usage
    - Refactor `frontend/src/hooks/useAuth.ts` to use simplified store
    - Remove complex React Query integration, use direct API calls with proper error handling
    - Implement automatic token refresh on API calls
    - Add helper functions: hasRole, isAdmin, isClinicAdmin, isTherapist
    - Implement page reload validation with database sync

- [x] 2.0 Implement Streamlined Registration Flow
  - [x] 2.1 Create registration form component
    - Create `frontend/src/components/auth/RegistrationForm.tsx` with fields: name, email, password, password confirmation
    - Implement form validation using Zod schema in `frontend/src/schemas/authSchema.ts`
    - Add password strength validation and email format validation
    - Include loading states and error handling
    - Style with existing design system components
  - [x] 2.2 Create email verification component
    - Create `frontend/src/components/auth/EmailVerificationForm.tsx` for verification code input
    - Add "Resend code" functionality with cooldown timer
    - Implement code validation and error states
    - Add admin manual verification option (if user has admin role)
  - [x] 2.3 Create registration success page
    - Create `frontend/src/components/auth/RegistrationSuccess.tsx` with success message
    - Include login button that redirects to login page
    - Add brief explanation of next steps
  - [x] 2.4 Implement backend registration with email verification
    - Update `backend/src/registration/registration.service.ts` to generate email verification tokens
    - Add email sending functionality for verification codes
    - Implement token expiration and validation logic
    - Add admin manual verification endpoint
  - [x] 2.5 Add registration API endpoints
    - Update `backend/src/registration/registration.controller.ts` with email verification endpoints
    - Add `/registration/verify-email` endpoint for code verification
    - Add `/registration/resend-code` endpoint for code resending
    - Add `/registration/admin-verify` endpoint for manual verification
    - Create `frontend/src/lib/api/registration.ts` client for registration API calls

- [ ] 3.0 Implement Smart Login Flow with Role-Based Redirects
  - [ ] 3.1 Update login form component
    - Update or create `frontend/src/components/auth/LoginForm.tsx` with email and password fields
    - Implement form validation and error handling
    - Add loading states and success feedback
    - Style consistently with registration form
  - [ ] 3.2 Implement smart redirect logic
    - Update `frontend/src/hooks/useAuth.ts` with redirect logic after successful login
    - System admin users → redirect to `/portal`
    - Clinic admin users without clinic/subscription → redirect to `/onboarding`
    - Clinic admin users with complete data → redirect to `/portal`
    - Therapist users → redirect to `/portal`
    - Add loading states during redirect determination
  - [ ] 3.3 Update route guard component
    - Refactor `frontend/src/components/auth/RouteGuard.tsx` to use simplified auth state
    - Implement proper loading states during auth validation
    - Add automatic redirect logic based on user state
    - Handle edge cases: expired tokens, invalid users, network errors
  - [ ] 3.4 Streamline backend login response
    - Update `backend/src/auth/auth.service.ts` to return simplified user data structure
    - Ensure response includes all required fields: user info, clinic info, roles, tokens
    - Add proper error handling and validation
    - Implement consistent response format across all auth endpoints

- [ ] 4.0 Create Resumable Onboarding Flow
  - [ ] 4.1 Refactor onboarding store
    - Simplify `frontend/src/store/onboarding.ts` to focus on essential data only
    - Implement step persistence with localStorage
    - Add resume functionality that checks current user state
    - Remove complex state management, keep only necessary data
  - [ ] 4.2 Update onboarding flow component
    - Refactor `frontend/src/components/onboarding/OnboardingFlow.tsx` for resumable flow
    - Implement step determination logic: clinic form → subscription → payment → thank you
    - Add automatic redirect to `/portal` if user has complete clinic and subscription data
    - Implement step validation and error handling
  - [ ] 4.3 Create onboarding step components
    - Update clinic form component with proper validation and error handling
    - Update subscription selector with clear pricing and feature information
    - Update payment page with secure payment processing
    - Create thank you page with 5-second redirect timer to `/portal`
  - [ ] 4.4 Implement onboarding state validation
    - Add logic to check if user has clinic data (show clinic form if missing)
    - Add logic to check if user has subscription (show subscription selector if missing)
    - Implement automatic step progression based on user state
    - Add proper error handling for incomplete onboarding data

- [ ] 5.0 Implement Real-time Data Validation and Error Handling
  - [ ] 5.1 Implement page reload validation
    - Update `frontend/src/hooks/useAuth.ts` to validate auth data on every page reload
    - Cache user data but validate clinic/subscription status against database
    - Implement efficient validation that doesn't impact performance
    - Add validation timestamps to prevent excessive API calls
  - [ ] 5.2 Add network error handling
    - Implement retry logic with exponential backoff for network failures
    - Add offline detection and graceful degradation
    - Implement proper error messages for different failure scenarios
    - Add fallback mechanisms for critical auth operations
  - [ ] 5.3 Implement automatic token refresh
    - Add automatic token refresh when access tokens expire during session
    - Implement seamless token refresh without user interruption
    - Add proper error handling for refresh token failures
    - Implement logout on refresh token expiration
  - [ ] 5.4 Add data synchronization
    - Implement logout when clinic is deleted or deactivated from database
    - Add real-time validation of user permissions and clinic status
    - Implement proper cleanup when user data becomes invalid
    - Add audit logging for critical auth state changes

- [ ] 6.0 Cleanup and Migration
  - [ ] 6.1 Remove deprecated auth code
    - Remove old auth components and files that are no longer needed
    - Clean up unused imports and dependencies in auth-related files
    - Remove deprecated API endpoints and unused backend services
    - Delete old test files for removed components
  - [ ] 6.2 Update documentation and comments
    - Update code comments to reflect new simplified auth structure
    - Update README files with new auth flow documentation
    - Update API documentation for new auth endpoints
    - Add migration notes for developers
  - [ ] 6.3 Database migration and cleanup
    - Run any necessary database migrations for auth-related schema changes
    - Clean up unused database fields or tables if any
    - Update database seeders to work with new auth structure
    - Verify all existing user data is compatible with new system
  - [ ] 6.4 Testing and validation
    - Run comprehensive tests to ensure all auth flows work correctly
    - Test edge cases: expired tokens, network failures, invalid data
    - Validate that all user types can login and access appropriate areas
    - Test onboarding flow with different user scenarios
    - Verify email verification works correctly
  - [ ] 6.5 Performance optimization
    - Optimize auth API calls to minimize database queries
    - Implement proper caching for frequently accessed auth data
    - Review and optimize token refresh mechanisms
    - Ensure auth validation doesn't impact page load performance
  - [ ] 6.6 Security audit
    - Review all auth endpoints for security vulnerabilities
    - Verify token storage and transmission security
    - Check for proper input validation and sanitization
    - Ensure no sensitive data is exposed in client-side code
    - Validate that all auth flows follow security best practices
