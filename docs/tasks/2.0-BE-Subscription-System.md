# 2.0-BE-Subscription-System

## Description
Implement the subscription management system for Terapintar with tier-based limits, usage tracking, and billing management.

## Dependencies
- 1.0-BE-Authentication-System (for user and clinic entities)

## Files to Create/Modify
- `backend/src/subscription/subscription.controller.ts` - Subscription controller
- `backend/src/subscription/subscription.service.ts` - Subscription service
- `backend/src/subscription/subscription.module.ts` - Subscription module
- `backend/src/entities/Subscription.ts` - Subscription entity
- `backend/src/entities/Usage.ts` - Usage tracking entity
- `backend/src/dto/subscription.dto.ts` - Subscription DTOs
- `backend/src/interceptors/usage.interceptor.ts` - Usage tracking interceptor
- `backend/src/guards/subscription.guard.ts` - Subscription limit guard

## Tasks

### 2.1-BE-Subscription-Entities
- [ ] Create Subscription and Usage entities
- [ ] Implement tier-based limits
- [ ] Add usage tracking model
- [ ] Create billing cycle management

**Implementation Steps:**
1. Create Subscription entity with tier information
2. Implement Usage entity for daily tracking
3. Set up tier-based limit configurations
4. Create billing cycle management system
5. Implement usage reset logic for daily limits
6. Add subscription history tracking
7. Create subscription upgrade/downgrade logic
8. Implement billing date calculations

### 2.2-BE-Subscription-Controllers
- [ ] Implement subscription management endpoints
- [ ] Create usage tracking endpoints
- [ ] Add limit enforcement logic
- [ ] Implement upgrade/downgrade functionality

**Implementation Steps:**
1. Create subscription CRUD endpoints
2. Implement usage tracking and reporting endpoints
3. Add limit enforcement middleware
4. Create upgrade/downgrade endpoints
5. Implement usage analytics endpoints
6. Add subscription billing endpoints
7. Create usage notification endpoints
8. Implement subscription export functionality

## Database Schema
```sql
-- Subscriptions table
CREATE TABLE subscriptions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  clinic_id UUID REFERENCES clinics(id),
  tier VARCHAR(50) NOT NULL CHECK (tier IN ('alpha', 'beta', 'theta', 'delta')),
  status VARCHAR(50) DEFAULT 'active',
  billing_amount INTEGER NOT NULL,
  billing_cycle VARCHAR(20) DEFAULT 'monthly',
  next_billing_date DATE NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Usage tracking table
CREATE TABLE usage (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  clinic_id UUID REFERENCES clinics(id),
  date DATE NOT NULL,
  therapists_used INTEGER DEFAULT 0,
  clients_added INTEGER DEFAULT 0,
  scripts_generated INTEGER DEFAULT 0,
  recommendations_used INTEGER DEFAULT 0,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
  UNIQUE(clinic_id, date)
);

-- Subscription limits table
CREATE TABLE subscription_limits (
  tier VARCHAR(50) PRIMARY KEY,
  max_therapists INTEGER NOT NULL,
  max_clients_per_day INTEGER NOT NULL,
  max_scripts_per_client_session INTEGER NOT NULL,
  max_recommendation_techniques INTEGER NOT NULL,
  price_monthly INTEGER NOT NULL,
  created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- Insert default limits
INSERT INTO subscription_limits VALUES
  ('beta', 1, 1, 1, 10, 30000),
  ('alpha', 2, 4, 2, 25, 50000),
  ('theta', 4, 15, 3, 40, 100000),
  ('delta', 6, 30, 5, 67, 150000);
```

## Success Criteria
- [ ] Subscription entities are properly created and managed
- [ ] Usage tracking works accurately for daily limits
- [ ] Limit enforcement prevents exceeding subscription limits
- [ ] Upgrade/downgrade functionality works smoothly
- [ ] Usage analytics provide accurate data
- [ ] Billing cycle management is functional
- [ ] Usage notifications are sent when approaching limits
- [ ] All subscription operations are properly validated

## Testing
- [ ] Unit tests for subscription service
- [ ] Unit tests for usage tracking
- [ ] Integration tests for subscription endpoints
- [ ] E2E tests for subscription management flow 