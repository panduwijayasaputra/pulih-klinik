# Task 2.0: Implement Email Verification System

## Relevant Files

- `frontend/src/components/auth/EmailVerification.tsx` - New email verification component (created with full functionality)
- `frontend/src/components/auth/ClinicForm.tsx` - Clinic form that triggers verification (updated with email sending)
- `frontend/src/components/auth/RegisterFlow.tsx` - Registration flow (updated to use EmailVerification component)
- `frontend/src/store/registration.ts` - Registration store with verification logic (already updated in Task 1.0)
- `frontend/src/types/registration.ts` - Verification types and schemas (already updated in Task 1.0)
- `frontend/src/hooks/useRegistration.ts` - Registration API hook (created with mock API functions)
- `frontend/src/components/auth/EmailVerification.test.tsx` - Unit tests (to be created)

### Notes

- Use mock API calls for development
- Unit tests should be placed alongside the code files they are testing
- Use `npx jest [optional/path/to/test/file]` to run tests

## Tasks

- [x] 2.1 Create EmailVerification component
  - [x] Create new component with verification code input
    - Add 6-digit code input with auto-focus
    - Add proper input validation and formatting
    - Add visual feedback for code entry
    - Add accessibility features (ARIA labels, keyboard navigation)
  - [x] Add resend verification code functionality
    - Add resend button with countdown timer
    - Add rate limiting (60-second cooldown)
    - Add visual feedback for resend attempts
    - Add error handling for resend failures
  - [x] Add countdown timer for resend cooldown
    - Implement countdown from 60 seconds
    - Update button state based on countdown
    - Persist countdown across component re-renders
    - Add visual countdown indicator
  - [x] Add proper error handling and validation
    - Add validation for code format (6 digits)
    - Add error messages for invalid codes
    - Add loading states for verification attempts
    - Add success feedback for verification

- [x] 2.2 Update ClinicForm to trigger email verification
  - [x] Modify form submission to send verification email
    - Update form submission handler
    - Add email sending before proceeding to verification step
    - Add loading state during email sending
    - Add error handling for email sending failures
  - [x] Add loading state during email sending
    - Show loading spinner on submit button
    - Disable form inputs during sending
    - Add progress indicator
    - Add timeout handling for slow responses
  - [x] Add success/error feedback for email sending
    - Show success message when email is sent
    - Show error message if email sending fails
    - Add retry functionality for failed sends
    - Add user-friendly error messages

- [x] 2.3 Add verification API integration
  - [x] Create API endpoints for sending verification emails
    - Add mock API function for sending emails
    - Add proper error handling and responses
    - Add rate limiting simulation
    - Add email validation before sending
  - [x] Create API endpoints for verifying codes
    - Add mock API function for code verification
    - Add validation for code format and attempts
    - Add success/failure responses
    - Add timeout handling
  - [x] Add proper error handling for verification failures
    - Handle network errors gracefully
    - Handle invalid code errors
    - Handle rate limiting errors
    - Handle timeout errors
  - [x] Add rate limiting for verification attempts
    - Limit verification attempts to 3 per code
    - Add cooldown period between attempts
    - Add visual feedback for remaining attempts
    - Add account lockout simulation after max attempts

## Implementation Steps

### Step 1: Create EmailVerification Component
```typescript
// In components/auth/EmailVerification.tsx
interface EmailVerificationProps {
  email: string;
  onVerificationSuccess: () => void;
  onResendEmail: () => Promise<void>;
}

export const EmailVerification: React.FC<EmailVerificationProps> = ({
  email,
  onVerificationSuccess,
  onResendEmail
}) => {
  const [code, setCode] = useState('');
  const [loading, setLoading] = useState(false);
  const [error, setError] = useState('');
  const [countdown, setCountdown] = useState(0);
  
  // Implementation details...
};
```

### Step 2: Update ClinicForm
```typescript
// In components/auth/ClinicForm.tsx
const onSubmit = async (formData: ClinicDataFormData) => {
  try {
    setLoading(true);
    clearError();
    
    // Send verification email
    await sendVerificationEmail(formData.adminEmail);
    
    // Update store and proceed
    updateClinicData(formData);
    nextStep();
  } catch (error) {
    setError('Gagal mengirim email verifikasi. Silakan coba lagi.');
  } finally {
    setLoading(false);
  }
};
```

### Step 3: Add API Integration
```typescript
// In hooks/useRegistration.ts
export const useRegistration = () => {
  const sendVerificationEmail = async (email: string) => {
    // Mock API call
    await new Promise(resolve => setTimeout(resolve, 1000));
    return { success: true, message: 'Verification email sent' };
  };

  const verifyCode = async (code: string) => {
    // Mock API call
    await new Promise(resolve => setTimeout(resolve, 500));
    return { success: code === '123456', message: 'Code verified' };
  };

  return { sendVerificationEmail, verifyCode };
};
```

## Testing Checklist

- [ ] Test verification code input validation
- [ ] Test resend functionality with countdown
- [ ] Test rate limiting for verification attempts
- [ ] Test email sending from clinic form
- [ ] Test error handling for all scenarios
- [ ] Test accessibility features
- [ ] Test loading states and feedback
- [ ] Test component integration with store

## Mock Data

```typescript
// Mock verification responses
export const mockVerificationResponses = {
  sendEmail: {
    success: { success: true, message: 'Verification email sent successfully' },
    error: { success: false, message: 'Failed to send verification email' },
    rateLimit: { success: false, message: 'Too many attempts, try again later' }
  },
  verifyCode: {
    success: { success: true, message: 'Code verified successfully' },
    invalid: { success: false, message: 'Invalid verification code' },
    expired: { success: false, message: 'Verification code has expired' },
    maxAttempts: { success: false, message: 'Maximum attempts reached' }
  }
};

// Mock countdown timer
export const mockCountdownTimer = {
  duration: 60,
  interval: 1000,
  onComplete: () => console.log('Countdown completed')
};

// Mock email validation
export const mockEmailValidation = (email: string) => {
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return emailRegex.test(email);
};
```

## Component Structure

```
EmailVerification/
├── EmailVerification.tsx
├── EmailVerification.test.tsx
├── components/
│   ├── VerificationCodeInput.tsx
│   ├── ResendButton.tsx
│   └── CountdownTimer.tsx
└── hooks/
    └── useVerification.ts
```
