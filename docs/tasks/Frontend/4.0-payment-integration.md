# Task 4.0: Update Payment Integration

## Relevant Files

- `frontend/src/components/payment/PaymentModal.tsx` - Payment component with Midtrans integration
- `frontend/src/types/registration.ts` - Payment types and schemas
- `frontend/src/store/registration.ts` - Payment state management
- `frontend/src/lib/midtrans.ts` - Midtrans SDK integration
- `frontend/src/hooks/usePayment.ts` - Payment API hook
- `frontend/src/components/payment/PaymentModal.test.tsx` - Unit tests

### Notes

- Use mock Midtrans integration for development
- Unit tests should be placed alongside the code files they are testing
- Use `npx jest [optional/path/to/test/file]` to run tests

## Tasks

- [ ] 4.1 Integrate Midtrans payment gateway
  - [ ] Replace mock payment with actual Midtrans integration
    - Add Midtrans SDK to project dependencies
    - Configure Midtrans client with test credentials
    - Implement payment token generation
    - Add payment method detection
  - [ ] Add Midtrans SDK and configuration
    - Install @midtrans/midtrans-js package
    - Add Midtrans configuration constants
    - Set up environment variables for API keys
    - Add test/production environment switching
  - [ ] Implement payment status tracking
    - Add payment status polling
    - Implement webhook handling
    - Add payment timeout handling
    - Add payment retry functionality
  - [ ] Add payment success/failure handling
    - Handle successful payment completion
    - Handle payment failures and errors
    - Add payment cancellation handling
    - Implement payment recovery flows

- [ ] 4.2 Update PaymentModal for token-based model
  - [ ] Change from subscription payment to registration fee payment
    - Update payment amount to IDR 100,000
    - Remove subscription tier selection
    - Update payment description
    - Modify payment flow logic
  - [ ] Update payment amount to IDR 100,000
    - Set fixed registration fee amount
    - Remove dynamic pricing calculation
    - Update tax calculation (if applicable)
    - Add currency formatting
  - [ ] Add token package information display
    - Show included tokens (3 tokens)
    - Display token value calculation
    - Add token usage information
    - Show future token pricing
  - [ ] Update payment instructions for registration fee
    - Update payment method descriptions
    - Modify payment confirmation messages
    - Update success/failure messages
    - Add registration-specific instructions

- [ ] 4.3 Add payment verification and account activation
  - [ ] Implement payment status checking
    - Add payment status polling mechanism
    - Implement status update notifications
    - Add payment timeout handling
    - Add payment verification API calls
  - [ ] Add automatic account activation on successful payment
    - Trigger account activation on payment success
    - Send activation confirmation email
    - Update user status in store
    - Redirect to login page
  - [ ] Add manual verification process for bank transfers
    - Add manual verification form
    - Implement receipt upload functionality
    - Add verification status tracking
    - Add admin approval workflow
  - [ ] Add payment confirmation email
    - Send payment confirmation email
    - Include payment receipt details
    - Add account activation instructions
    - Include support contact information

## Implementation Steps

### Step 1: Midtrans Integration
```typescript
// In lib/midtrans.ts
import { loadScript } from '@midtrans/midtrans-js';

export class MidtransClient {
  private snap: any;
  
  constructor() {
    this.initializeMidtrans();
  }
  
  private async initializeMidtrans() {
    await loadScript({ src: 'https://app.sandbox.midtrans.com/snap/snap.js' });
    this.snap = (window as any).snap;
  }
  
  async createPaymentToken(orderData: any) {
    // Mock implementation for development
    return {
      token: 'mock-payment-token-' + Date.now(),
      redirect_url: 'https://mock-payment-gateway.com'
    };
  }
  
  async checkPaymentStatus(orderId: string) {
    // Mock implementation
    return { status: 'success', order_id: orderId };
  }
}
```

### Step 2: Update PaymentModal
```typescript
// In components/payment/PaymentModal.tsx
export const PaymentModal: React.FC = () => {
  const { data, updatePaymentData, submitRegistration } = useRegistrationStore();
  const { createPayment, checkPaymentStatus } = usePayment();
  
  const registrationFee = 100000;
  const includedTokens = 3;
  const tokenValue = includedTokens * 20000;
  const totalAmount = registrationFee;
  
  const handlePayment = async (paymentMethod: string) => {
    try {
      const paymentData = {
        amount: totalAmount,
        order_id: `REG-${Date.now()}`,
        clinic_data: data.clinic,
        payment_method: paymentMethod
      };
      
      const result = await createPayment(paymentData);
      
      if (result.success) {
        // Redirect to payment gateway or show payment instructions
        window.location.href = result.redirect_url;
      }
    } catch (error) {
      console.error('Payment failed:', error);
    }
  };
  
  // Implementation details...
};
```

### Step 3: Payment Hook
```typescript
// In hooks/usePayment.ts
export const usePayment = () => {
  const createPayment = async (paymentData: any) => {
    // Mock API call
    await new Promise(resolve => setTimeout(resolve, 1000));
    return {
      success: true,
      order_id: paymentData.order_id,
      redirect_url: 'https://mock-payment-gateway.com',
      payment_token: 'mock-token-' + Date.now()
    };
  };
  
  const checkPaymentStatus = async (orderId: string) => {
    // Mock API call
    await new Promise(resolve => setTimeout(resolve, 500));
    return {
      status: 'success',
      order_id: orderId,
      amount: 100000,
      payment_method: 'bank_transfer'
    };
  };
  
  return { createPayment, checkPaymentStatus };
};
```

## Testing Checklist

- [ ] Test Midtrans SDK integration
- [ ] Test payment token generation
- [ ] Test payment status checking
- [ ] Test payment success/failure handling
- [ ] Test payment amount calculation
- [ ] Test payment method selection
- [ ] Test payment confirmation flow
- [ ] Test account activation on payment success

## Mock Data

```typescript
// Mock Midtrans configuration
export const mockMidtransConfig = {
  clientKey: 'SB-Mid-client-1234567890',
  serverKey: 'SB-Mid-server-1234567890',
  environment: 'sandbox',
  apiUrl: 'https://api.sandbox.midtrans.com'
};

// Mock payment responses
export const mockPaymentResponses = {
  createPayment: {
    success: {
      success: true,
      order_id: 'REG-1234567890',
      redirect_url: 'https://app.sandbox.midtrans.com/snap/v2/vtweb/1234567890',
      payment_token: 'mock-payment-token-1234567890'
    },
    error: {
      success: false,
      message: 'Payment creation failed'
    }
  },
  checkStatus: {
    success: {
      status: 'success',
      order_id: 'REG-1234567890',
      amount: 100000,
      payment_method: 'bank_transfer'
    },
    pending: {
      status: 'pending',
      order_id: 'REG-1234567890',
      amount: 100000
    },
    failed: {
      status: 'failed',
      order_id: 'REG-1234567890',
      message: 'Payment failed'
    }
  }
};

// Mock payment methods
export const mockPaymentMethods = [
  {
    id: 'bank_transfer',
    name: 'Transfer Bank',
    description: 'BCA, Mandiri, BRI, BNI',
    processingTime: '1-24 jam',
    icon: 'bank-icon'
  },
  {
    id: 'credit_card',
    name: 'Kartu Kredit/Debit',
    description: 'Visa, Mastercard, JCB',
    processingTime: 'Instan',
    icon: 'card-icon'
  },
  {
    id: 'ewallet',
    name: 'E-Wallet',
    description: 'GoPay, OVO, DANA, LinkAja',
    processingTime: 'Instan',
    icon: 'wallet-icon'
  }
];
```

## Component Structure

```
PaymentModal/
├── PaymentModal.tsx
├── PaymentModal.test.tsx
├── components/
│   ├── PaymentMethodSelector.tsx
│   ├── PaymentSummary.tsx
│   ├── PaymentInstructions.tsx
│   └── PaymentStatus.tsx
├── hooks/
│   └── usePayment.ts
└── lib/
    └── midtrans.ts
```

## Security Considerations

- Secure API key storage
- Payment data encryption
- CSRF protection for payment forms
- Secure payment status verification
- Input validation and sanitization
- Secure session management
