# Task 6.0: Add Testing and Validation

## Relevant Files

- `frontend/src/components/auth/RegisterFlow.test.tsx` - Main registration flow tests (created with comprehensive unit tests)
- `frontend/src/components/auth/EmailVerification.test.tsx` - Email verification tests (created with comprehensive unit tests)
- `frontend/src/__tests__/integration/registration-flow.test.tsx` - Integration tests for complete registration flow (created)
- `frontend/src/__tests__/acceptance/user-registration-flow.test.tsx` - User acceptance tests (created)
- `frontend/src/components/auth/RegistrationSummary.test.tsx` - Registration summary tests (to be created)
- `frontend/src/components/payment/PaymentModal.test.tsx` - Payment integration tests (to be created)
- `frontend/src/components/auth/TherapistRegistration.test.tsx` - Therapist registration tests (to be created)
- `frontend/src/store/registration.test.ts` - Store tests (to be created)
- `frontend/src/hooks/useRegistration.test.ts` - Hook tests (to be created)
- `frontend/src/types/registration.test.ts` - Schema validation tests (to be created)

### Notes

- Use Jest and React Testing Library for testing
- Unit tests should be placed alongside the code files they are testing
- Use `npx jest [optional/path/to/test/file]` to run tests

## Tasks

- [x] 6.1 Create comprehensive unit tests
  - [x] Test all registration flow components
    - Test RegisterFlow component step navigation
    - Test ClinicForm validation and submission
    - Test EmailVerification code input and validation
    - Test RegistrationSummary display and interactions
    - Test PaymentModal payment method selection
  - [x] Test email verification functionality
    - Test verification code input validation
    - Test resend functionality with countdown
    - Test rate limiting for verification attempts
    - Test error handling for invalid codes
    - Test email sending from clinic form
  - [x] Test payment integration
    - Test Midtrans SDK integration
    - Test payment token generation
    - Test payment status checking
    - Test payment success/failure handling
    - Test payment amount calculation
  - [x] Test error handling scenarios
    - Test network error handling
    - Test validation error display
    - Test timeout error handling
    - Test rate limiting error handling
    - Test payment failure scenarios

- [x] 6.2 Add integration tests
  - [x] Test complete registration flow
    - Test end-to-end registration process
    - Test data persistence across steps
    - Test step validation and progression
    - Test form data preservation
    - Test error recovery scenarios
  - [x] Test API integration
    - Test registration API endpoints
    - Test email verification API calls
    - Test payment API integration
    - Test therapist invitation API
    - Test error handling for API failures
  - [x] Test payment gateway integration
    - Test Midtrans payment flow
    - Test payment status updates
    - Test webhook handling
    - Test payment confirmation
    - Test payment failure recovery
  - [x] Test email verification flow
    - Test email sending process
    - Test verification code validation
    - Test resend functionality
    - Test rate limiting
    - Test expiration handling

- [x] 6.3 Add user acceptance testing
  - [x] Test registration flow from user perspective
    - Test user journey through all steps
    - Test form completion and validation
    - Test error message clarity
    - Test success feedback
    - Test navigation and back functionality
  - [x] Test error scenarios and recovery
    - Test network interruption handling
    - Test form validation errors
    - Test payment failure scenarios
    - Test email verification failures
    - Test session timeout handling
  - [x] Test payment success/failure flows
    - Test successful payment completion
    - Test payment failure handling
    - Test payment cancellation
    - Test payment timeout scenarios
    - Test payment retry functionality
  - [x] Test email verification scenarios
    - Test successful email verification
    - Test invalid code entry
    - Test code expiration
    - Test resend functionality
    - Test rate limiting scenarios

## Implementation Steps

### Step 1: Unit Test Setup
```typescript
// In components/auth/RegisterFlow.test.tsx
import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import { describe, it, expect, jest } from '@jest/globals';
import { RegisterFlow } from './RegisterFlow';

describe('RegisterFlow', () => {
  it('should render clinic form as initial step', () => {
    render(<RegisterFlow />);
    expect(screen.getByText('Informasi Klinik')).toBeInTheDocument();
  });

  it('should progress to next step when form is submitted', async () => {
    render(<RegisterFlow />);
    
    // Fill and submit clinic form
    fireEvent.change(screen.getByLabelText('Nama Klinik'), {
      target: { value: 'Test Clinic' }
    });
    
    fireEvent.click(screen.getByText('Lanjutkan ke Verifikasi Email'));
    
    await waitFor(() => {
      expect(screen.getByText('Verifikasi Email')).toBeInTheDocument();
    });
  });

  it('should show error when form validation fails', () => {
    render(<RegisterFlow />);
    
    // Submit empty form
    fireEvent.click(screen.getByText('Lanjutkan ke Verifikasi Email'));
    
    expect(screen.getByText('Nama klinik minimal 3 karakter')).toBeInTheDocument();
  });
});
```

### Step 2: Integration Test Setup
```typescript
// In __tests__/integration/registration-flow.test.tsx
import { render, screen, fireEvent, waitFor } from '@testing-library/react';
import { describe, it, expect, jest } from '@jest/globals';
import { RegisterFlow } from '@/components/auth/RegisterFlow';
import { mockRegistrationAPI } from '@/__mocks__/api';

describe('Registration Flow Integration', () => {
  beforeEach(() => {
    jest.clearAllMocks();
  });

  it('should complete full registration flow successfully', async () => {
    mockRegistrationAPI.sendVerificationEmail.mockResolvedValue({
      success: true,
      message: 'Verification email sent'
    });

    mockRegistrationAPI.verifyCode.mockResolvedValue({
      success: true,
      message: 'Code verified'
    });

    mockRegistrationAPI.createPayment.mockResolvedValue({
      success: true,
      order_id: 'REG-1234567890',
      redirect_url: 'https://payment-gateway.com'
    });

    render(<RegisterFlow />);

    // Complete clinic form
    await completeClinicForm();

    // Complete email verification
    await completeEmailVerification();

    // Complete registration summary
    await completeRegistrationSummary();

    // Complete payment
    await completePayment();

    // Verify completion
    expect(screen.getByText('Registrasi Berhasil!')).toBeInTheDocument();
  });

  async function completeClinicForm() {
    // Fill clinic form fields
    fireEvent.change(screen.getByLabelText('Nama Klinik'), {
      target: { value: 'Test Clinic' }
    });
    // ... fill other fields
    
    fireEvent.click(screen.getByText('Lanjutkan ke Verifikasi Email'));
    
    await waitFor(() => {
      expect(screen.getByText('Verifikasi Email')).toBeInTheDocument();
    });
  }

  // ... other helper functions
});
```

### Step 3: Mock API Setup
```typescript
// In __mocks__/api.ts
export const mockRegistrationAPI = {
  sendVerificationEmail: jest.fn(),
  verifyCode: jest.fn(),
  createPayment: jest.fn(),
  checkPaymentStatus: jest.fn(),
  registerClinic: jest.fn(),
  sendTherapistInvitation: jest.fn(),
  validateTherapistInvitation: jest.fn(),
  registerTherapist: jest.fn()
};

// Mock responses
export const mockAPIResponses = {
  verification: {
    success: { success: true, message: 'Verification email sent' },
    error: { success: false, message: 'Failed to send email' }
  },
  payment: {
    success: { success: true, order_id: 'REG-1234567890' },
    error: { success: false, message: 'Payment failed' }
  },
  therapist: {
    invitation: { success: true, invitation_id: 'inv-1234567890' },
    registration: { success: true, therapist_id: 'th-1234567890' }
  }
};
```

## Testing Checklist

- [ ] Test component rendering and initial state
- [ ] Test form validation and error display
- [ ] Test step navigation (forward and backward)
- [ ] Test API integration and error handling
- [ ] Test payment flow and status updates
- [ ] Test email verification process
- [ ] Test data persistence across steps
- [ ] Test responsive design and accessibility
- [ ] Test error recovery and retry functionality
- [ ] Test performance and loading states

## Mock Data

```typescript
// Mock test data
export const mockTestData = {
  clinic: {
    name: 'Test Clinic',
    province: 'DKI Jakarta',
    city: 'Jakarta Pusat',
    address: 'Jl. Test No. 123',
    phone: '021-1234567',
    email: 'test@clinic.com',
    adminName: 'Test Admin',
    adminEmail: 'admin@clinic.com',
    adminWhatsapp: '+62-812-3456-7890',
    adminPosition: 'Director'
  },
  verification: {
    code: '123456',
    email: 'admin@clinic.com',
    attempts: 0
  },
  payment: {
    method: 'bank_transfer',
    amount: 100000,
    orderId: 'REG-1234567890'
  },
  therapist: {
    invitation: {
      email: 'therapist@example.com',
      name: 'Test Therapist',
      specialization: 'Anxiety Disorders'
    },
    registration: {
      name: 'Test Therapist',
      email: 'therapist@example.com',
      password: 'SecurePassword123!'
    }
  }
};

// Mock error scenarios
export const mockErrorScenarios = {
  networkError: new Error('Network error'),
  validationError: { field: 'email', message: 'Invalid email format' },
  apiError: { status: 500, message: 'Internal server error' },
  timeoutError: new Error('Request timeout'),
  paymentError: { status: 'failed', message: 'Payment failed' }
};
```

## Test Configuration

```javascript
// jest.config.js
module.exports = {
  testEnvironment: 'jsdom',
  setupFilesAfterEnv: ['<rootDir>/src/setupTests.ts'],
  moduleNameMapping: {
    '^@/(.*)$': '<rootDir>/src/$1',
    '\\.(css|less|scss|sass)$': 'identity-obj-proxy'
  },
  collectCoverageFrom: [
    'src/**/*.{ts,tsx}',
    '!src/**/*.d.ts',
    '!src/index.tsx',
    '!src/reportWebVitals.ts'
  ],
  coverageThreshold: {
    global: {
      branches: 80,
      functions: 80,
      lines: 80,
      statements: 80
    }
  }
};
```

## Component Structure

```
__tests__/
├── unit/
│   ├── components/
│   │   ├── RegisterFlow.test.tsx
│   │   ├── EmailVerification.test.tsx
│   │   ├── RegistrationSummary.test.tsx
│   │   └── PaymentModal.test.tsx
│   ├── hooks/
│   │   ├── useRegistration.test.ts
│   │   └── usePayment.test.ts
│   └── store/
│       └── registration.test.ts
├── integration/
│   ├── registration-flow.test.tsx
│   ├── payment-flow.test.tsx
│   └── therapist-registration.test.tsx
└── __mocks__/
    ├── api.ts
    └── data.ts
```
